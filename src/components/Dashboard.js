import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
// src/components/Dashboard.tsx
import { TradingMode } from "../types";
import { Card, CardContent, CardHeader, CardTitle, } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Activity, AlertTriangle, TrendingUp, Zap } from "lucide-react";
import SettingsPanel from "./SettingsPanel";
import { useState } from "react";
const QTY_LIMITS = {
    BTCUSDT: { min: 0.001, max: 0.01 },
    ETHUSDT: { min: 0.01, max: 5 },
    SOLUSDT: { min: 0.1, max: 100 },
    ADAUSDT: { min: 1, max: 10000 },
};
export default function Dashboard({ mode, setMode, useTestnet, setUseTestnet, bot, }) {
    const [showSettings, setShowSettings] = useState(false);
    const { systemState, portfolioState, settings, pendingSignals, activePositions, logEntries, updateSettings, closePosition, entryHistory, testnetOrders, testnetTrades, ordersError, refreshTestnetOrders, assetPnlHistory, removeEntryHistoryItem, resetPnlHistory, } = bot;
    const setProfile = (profile) => {
        updateSettings({ ...settings, strategyProfile: profile });
    };
    return (_jsxs("div", { className: "space-y-6", children: [_jsxs("div", { className: "flex flex-col md:flex-row justify-between items-start md:items-center gap-4", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-3xl font-bold tracking-tight text-white", children: "Dashboard" }), _jsx("p", { className: "text-slate-400 hidden lg:block", children: "Autonomous trading system control center" })] }), _jsxs("div", { className: "flex flex-col sm:flex-row gap-4 items-start sm:items-center", children: [_jsx(Button, { variant: "outline", size: "sm", className: "text-slate-200", onClick: () => setShowSettings(true), children: "Settings" }), _jsxs("div", { className: "flex items-center bg-slate-900 p-1 rounded-lg border border-white/10", children: [_jsx(Button, { variant: useTestnet ? "secondary" : "ghost", size: "sm", onClick: () => setUseTestnet(true), className: useTestnet ? "bg-slate-800 text-white" : "text-slate-400 hover:text-white", children: "TESTNET" }), _jsx(Button, { variant: !useTestnet ? "secondary" : "ghost", size: "sm", onClick: () => setUseTestnet(false), className: !useTestnet ? "bg-emerald-600 text-white hover:bg-emerald-700" : "text-slate-400 hover:text-white", children: "MAINNET" })] }), _jsx("div", { className: "flex items-center bg-slate-900 p-1 rounded-lg border border-white/10", children: Object.values(TradingMode).map((m) => (_jsx(Button, { variant: mode === m ? "secondary" : "ghost", size: "sm", onClick: () => setMode(m), className: mode === m
                                        ? "bg-blue-600 text-white hover:bg-blue-700"
                                        : "text-slate-400 hover:text-white", children: m }, m))) })] })] }), showSettings && (_jsx(SettingsPanel, { theme: "dark", lang: "en", settings: settings, onUpdateSettings: (s) => updateSettings(s), onClose: () => setShowSettings(false) })), _jsxs("div", { className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6", children: [_jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsx(CardHeader, { className: "pb-2", children: _jsxs(CardTitle, { className: "text-sm font-medium text-slate-400 flex items-center gap-2", children: [_jsx(Activity, { className: "w-4 h-4" }), "System & Portfolio"] }) }), _jsx(CardContent, { children: _jsxs("div", { className: "space-y-4 text-sm", children: [_jsxs("div", { className: "space-y-2", children: [_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Bybit Connection" }), _jsx(Badge, { variant: "outline", className: systemState.bybitStatus === "Connected"
                                                                ? "border-emerald-500/50 text-emerald-500 bg-emerald-500/10"
                                                                : "border-red-500/50 text-red-500 bg-red-500/10", children: systemState.bybitStatus })] }), _jsxs("div", { className: "flex justify-between items-center", children: [_jsx("span", { className: "text-slate-400", children: "Latency" }), _jsxs("span", { className: "font-mono", children: [systemState.latency, " ms"] })] }), _jsxs("div", { className: "flex justify-between items-center", children: [_jsx("span", { className: "text-slate-400", children: "Last Error" }), _jsx("span", { className: "text-red-400 truncate max-w-[200px]", title: systemState.lastError ?? "", children: systemState.lastError ?? "None" })] })] }), _jsxs("div", { className: "space-y-2 pt-3 border-t border-white/10", children: [_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Total Capital" }), _jsxs("span", { className: "font-mono font-medium text-lg", children: ["$", portfolioState.totalCapital.toFixed(2)] })] }), settings.entryStrictness !== "test" ? (_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Allocated" }), _jsxs("span", { className: "font-mono text-slate-300", children: ["$", portfolioState.allocatedCapital.toFixed(2)] })] })) : (_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Allocated" }), _jsx("span", { className: "font-mono text-slate-500", children: "Disabled in TEST" })] })), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Daily PnL" }), _jsxs("span", { className: `font-mono ${portfolioState.dailyPnl >= 0
                                                                ? "text-emerald-500"
                                                                : "text-red-500"}`, children: [portfolioState.dailyPnl > 0 ? "+" : "", portfolioState.dailyPnl.toFixed(2), " USD"] })] })] })] }) })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsx(CardHeader, { className: "pb-2", children: _jsxs(CardTitle, { className: "text-sm font-medium text-slate-400 flex items-center gap-2", children: [_jsx(Zap, { className: "w-4 h-4" }), "AI Strategy"] }) }), _jsx(CardContent, { children: _jsxs("div", { className: "space-y-2 text-sm", children: [_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Profile" }), _jsx(Badge, { variant: "secondary", className: "capitalize bg-slate-800 text-slate-300 hover:bg-slate-700", children: settings.strategyProfile })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Risk Engine" }), _jsx(Badge, { variant: "outline", className: settings.riskMode === "ai-matic-x"
                                                        ? "border-emerald-500/50 text-emerald-400 bg-emerald-500/10"
                                                        : "border-slate-600 text-slate-200 bg-slate-800", children: settings.riskMode === "ai-matic-x" ? "AI-Matic-X" : "AI-Matic" })] }), _jsx("div", { className: "flex flex-wrap gap-2 pt-1", children: [
                                                { key: "off", label: "Off" },
                                                { key: "auto", label: "Auto" },
                                                { key: "coach", label: "Coach" },
                                                { key: "scalp", label: "Scalp" },
                                                { key: "intraday", label: "Intraday" },
                                                { key: "swing", label: "Swing" },
                                                { key: "trend", label: "Trend" },
                                            ].map((opt) => (_jsx(Button, { size: "sm", variant: settings.strategyProfile === opt.key ? "secondary" : "ghost", className: settings.strategyProfile === opt.key
                                                    ? "bg-emerald-600 text-white hover:bg-emerald-700"
                                                    : "text-slate-300 hover:text-white", onClick: () => setProfile(opt.key), children: opt.label }, opt.key))) }), _jsx("div", { className: "flex flex-wrap gap-2 pt-1", children: [
                                                { key: "ai-matic", label: "AI-Matic" },
                                                { key: "ai-matic-x", label: "AI-Matic-X" },
                                            ].map((opt) => (_jsx(Button, { size: "sm", variant: settings.riskMode === opt.key ? "secondary" : "ghost", className: settings.riskMode === opt.key
                                                    ? "bg-emerald-600 text-white hover:bg-emerald-700"
                                                    : "text-slate-300 hover:text-white", onClick: () => updateSettings({ ...settings, riskMode: opt.key }), children: opt.label }, opt.key))) }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Entry Strictness" }), _jsx(Badge, { variant: "outline", className: "capitalize border-slate-700 text-slate-300 bg-slate-800", children: settings.entryStrictness })] }), _jsx("div", { className: "flex flex-wrap gap-2 pt-1", children: [
                                                { key: "base", label: "Base" },
                                                { key: "relaxed", label: "Relaxed" },
                                                { key: "ultra", label: "Ultra" },
                                                { key: "test", label: "Test" },
                                            ].map((opt) => (_jsx(Button, { size: "sm", variant: settings.entryStrictness === opt.key ? "secondary" : "ghost", className: settings.entryStrictness === opt.key
                                                    ? "bg-blue-600 text-white hover:bg-blue-700"
                                                    : "text-slate-300 hover:text-white", onClick: () => updateSettings({ ...settings, entryStrictness: opt.key }), children: opt.label }, opt.key))) }), _jsxs("div", { className: "flex items-center justify-between pt-1", children: [_jsx("span", { className: "text-slate-400", children: "Enforce Trading Hours" }), _jsx(Button, { size: "sm", variant: settings.enforceSessionHours ? "secondary" : "ghost", className: settings.enforceSessionHours
                                                        ? "bg-amber-500 text-black hover:bg-amber-600"
                                                        : "text-slate-300 hover:text-white", onClick: () => updateSettings({
                                                        ...settings,
                                                        enforceSessionHours: !settings.enforceSessionHours,
                                                    }), children: settings.enforceSessionHours ? "On" : "Off" })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Base Risk" }), _jsxs("span", { className: "font-mono", children: [(settings.baseRiskPerTrade * 100).toFixed(2), "%"] })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Risk Budget" }), _jsxs("span", { className: "font-mono", children: [(settings.maxPortfolioRiskPercent * 100).toFixed(1), "% / ", settings.maxOpenPositions, " pos"] })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Max Allocation" }), _jsxs("span", { className: "font-mono", children: [(settings.maxAllocatedCapitalPercent * 100).toFixed(1), "%"] })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-slate-400", children: "Max Drawdown" }), _jsxs("span", { className: "font-mono", children: [(settings.maxDrawdownPercent * 100).toFixed(2), "%"] })] })] }) })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsx(CardHeader, { children: _jsxs(CardTitle, { className: "flex items-center gap-2", children: [_jsx(TrendingUp, { className: "w-5 h-5 text-blue-500" }), "Active Positions"] }) }), _jsxs(CardContent, { children: [activePositions.length === 0 ? (_jsx("div", { className: "text-sm text-slate-500 italic py-8 text-center border border-dashed border-slate-800 rounded-lg", children: "No open positions." })) : (_jsx("div", { className: "space-y-3", children: activePositions.map((p) => (_jsxs("div", { className: "flex items-center justify-between p-4 border border-white/5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors", children: [_jsxs("div", { children: [_jsxs("div", { className: "font-bold flex items-center gap-2 text-lg", children: [p.symbol, _jsx(Badge, { variant: "outline", className: p.side === "buy"
                                                                        ? "border-emerald-500/50 text-emerald-500 bg-emerald-500/10"
                                                                        : "border-red-500/50 text-red-500 bg-red-500/10", children: p.side.toUpperCase() })] }), _jsxs("div", { className: "text-xs text-slate-400 mt-1 font-mono", children: ["Entry: ", p.entryPrice, " | Size: ", p.size.toFixed(4)] })] }), _jsxs("div", { className: "text-right", children: [_jsxs("div", { className: `font-mono font-bold text-lg ${p.unrealizedPnl >= 0
                                                                ? "text-emerald-500"
                                                                : "text-red-500"}`, children: [p.unrealizedPnl > 0 ? "+" : "", p.unrealizedPnl.toFixed(2), " USD"] }), _jsxs("div", { className: "text-xs text-slate-400 mt-1 font-mono", children: ["TP: ", p.tp, " | SL: ", p.currentTrailingStop ?? p.sl] }), _jsx(Button, { size: "sm", variant: "ghost", className: "mt-2 text-red-400 hover:text-white hover:bg-red-500/10", onClick: () => closePosition(p.id), children: "Close" })] })] }, p.id))) })), _jsxs("div", { className: "mt-4 text-xs text-slate-500", children: ["Limits per asset (qty):", " ", Object.entries(QTY_LIMITS)
                                                .map(([sym, lim]) => `${sym} ${lim.min}–${lim.max}`)
                                                .join(" · ")] })] })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsx(CardHeader, { children: _jsxs(CardTitle, { className: "flex items-center gap-2", children: [_jsx(AlertTriangle, { className: "w-5 h-5 text-amber-500" }), "Pending Signals"] }) }), _jsx(CardContent, { children: pendingSignals.length === 0 ? (_jsx("div", { className: "text-sm text-slate-500 italic py-8 text-center border border-dashed border-slate-800 rounded-lg", children: "No signals detected." })) : (_jsx("div", { className: "space-y-3", children: pendingSignals.map((s) => (_jsxs("div", { className: "p-4 border border-white/5 rounded-lg bg-white/5 space-y-3", children: [_jsxs("div", { className: "flex justify-between items-center", children: [_jsx("span", { className: "font-bold", children: s.symbol }), _jsx(Badge, { variant: "outline", className: s.intent.side === "buy"
                                                            ? "border-emerald-500/50 text-emerald-500"
                                                            : "border-red-500/50 text-red-500", children: s.intent.side.toUpperCase() })] }), _jsxs("div", { className: "text-xs text-slate-400 font-mono", children: ["Entry: ", s.intent.entry, " | Risk: ", (s.risk * 100).toFixed(1), "%"] }), _jsxs("div", { className: "flex gap-2 pt-1", children: [_jsx(Button, { size: "sm", onClick: () => bot.executeTrade(s.id), className: "flex-1 bg-emerald-600 hover:bg-emerald-700 text-white", children: "Execute" }), _jsx(Button, { size: "sm", variant: "destructive", onClick: () => bot.rejectSignal(s.id), className: "flex-1", children: "Reject" })] })] }, s.id))) })) })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsx(CardHeader, { children: _jsx(CardTitle, { className: "text-sm font-medium text-slate-400", children: "Live Feed" }) }), _jsx(CardContent, { children: _jsx("div", { className: "h-[360px] overflow-y-auto space-y-2 pr-2 custom-scrollbar", children: logEntries.length === 0 ? (_jsx("div", { className: "text-sm text-slate-500 italic", children: "No activity yet." })) : (logEntries
                                        .filter((l) => {
                                        const msg = l.message || "";
                                        const allowed = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "ADAUSDT"];
                                        return allowed.some((s) => msg.includes(s));
                                    })
                                        .slice(0, 10)
                                        .map((l) => (_jsxs("div", { className: "text-sm flex gap-3 py-2 border-b border-white/5 last:border-0", children: [_jsx("span", { className: "text-slate-500 text-xs whitespace-nowrap font-mono w-20", children: new Date(l.timestamp).toLocaleTimeString([], {
                                                    hour12: false,
                                                    hour: "2-digit",
                                                    minute: "2-digit",
                                                    second: "2-digit",
                                                }) }), _jsx("span", { className: "font-medium text-blue-400 w-24 text-xs uppercase tracking-wider", children: l.action }), _jsx("span", { className: "text-slate-300", children: l.message })] }, l.id)))) }) })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium text-slate-400", children: "Entry History" }), _jsxs("span", { className: "text-xs text-slate-500", children: [entryHistory.length, " ulo\u017Een\u00FDch vstup\u016F"] })] }), _jsx(CardContent, { children: entryHistory.length === 0 ? (_jsx("div", { className: "text-sm text-slate-500 italic py-6 text-center border border-dashed border-slate-800 rounded-lg", children: "Zat\u00EDm \u017E\u00E1dn\u00E9 ulo\u017Een\u00E9 vstupy." })) : (_jsx("div", { className: "space-y-3", children: entryHistory.slice(0, 8).map((h) => (_jsxs("div", { className: "p-3 rounded-lg border border-white/5 bg-white/5", children: [_jsxs("div", { className: "flex items-center justify-between gap-2", children: [_jsxs("div", { className: "flex items-center gap-2", children: [_jsx("span", { className: "font-mono font-semibold", children: h.symbol }), _jsx(Badge, { variant: "outline", className: h.side === "buy" ? "border-emerald-500/50 text-emerald-500" : "border-red-500/50 text-red-500", children: h.side.toUpperCase() })] }), _jsx("button", { onClick: () => removeEntryHistoryItem(h.id), className: "text-xs text-slate-500 hover:text-red-400", title: "Odstranit ulo\u017Een\u00FD sign\u00E1l", children: "\u2715" })] }), _jsxs("div", { className: "text-xs text-slate-400 font-mono mt-1", children: ["Entry ", h.entryPrice, " | SL ", h.sl ?? "-", " | TP ", h.tp ?? "-", " | Size ", h.size.toFixed(3)] }), _jsxs("div", { className: "text-[11px] text-slate-500 mt-1", children: [new Date(h.createdAt).toLocaleString(), " \u00B7 ", h.settingsNote] })] }, h.id))) })) })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium text-slate-400", children: useTestnet ? "Testnet Orders" : "Bybit Orders" }), _jsxs("div", { className: "flex items-center gap-2", children: [ordersError && (_jsx("span", { className: "text-xs text-red-400 truncate max-w-[160px]", title: ordersError, children: ordersError })), _jsx(Button, { variant: "outline", size: "sm", onClick: () => refreshTestnetOrders(), className: "h-7 text-xs border-white/10 hover:bg-white/10 hover:text-white", children: "Refresh" })] })] }), _jsxs(CardContent, { children: [ordersError ? (_jsxs("div", { className: "text-sm text-red-400 italic py-6 text-center border border-red-500/30 bg-red-500/5 rounded-lg", children: ["Orders API failed: ", ordersError] })) : testnetOrders.length === 0 ? (_jsx("div", { className: "text-sm text-slate-500 italic py-6 text-center border border-dashed border-slate-800 rounded-lg", children: "\u017D\u00E1dn\u00E9 otev\u0159en\u00E9 testnet orders." })) : (_jsx("div", { className: "space-y-3", children: testnetOrders.slice(0, 8).map((o) => (_jsxs("div", { className: "p-3 rounded-lg border border-white/5 bg-white/5", children: [_jsxs("div", { className: "flex items-center justify-between", children: [_jsx("span", { className: "font-mono font-semibold", children: o.symbol }), _jsx(Badge, { variant: "outline", className: o.side === "Buy" ? "border-emerald-500/50 text-emerald-500" : "border-red-500/50 text-red-500", children: o.side })] }), _jsxs("div", { className: "text-xs text-slate-400 font-mono mt-1", children: ["Qty ", o.qty, " @ ", o.price ?? "mkt", " | ", o.status] }), _jsx("div", { className: "text-[11px] text-slate-500 mt-1", children: new Date(o.createdTime).toLocaleString() })] }, o.orderId))) })), testnetTrades.length > 0 && (_jsxs("div", { className: "mt-4 pt-3 border-t border-white/10", children: [_jsx("div", { className: "text-xs text-slate-400 mb-2", children: "Latest fills" }), _jsx("div", { className: "space-y-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar", children: testnetTrades.slice(0, 10).map((t) => (_jsxs("div", { className: "text-xs font-mono text-slate-300 flex justify-between", children: [_jsx("span", { className: "flex-1 truncate", children: t.symbol }), _jsx("span", { className: t.side === "Buy" ? "text-emerald-400" : "text-red-400", children: t.side }), _jsx("span", { children: t.qty }), _jsxs("span", { children: ["@", t.price] }), _jsx("span", { children: new Date(t.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" }) })] }, t.id))) })] }))] })] }), _jsxs(Card, { className: "bg-slate-900/50 border-white/10 text-white", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium text-slate-400", children: "Asset PnL History" }), _jsxs("div", { className: "flex items-center gap-2", children: [_jsxs("span", { className: "text-xs text-slate-500", children: [Object.keys(assetPnlHistory).length, " assets"] }), _jsx(Button, { variant: "outline", size: "sm", onClick: () => resetPnlHistory(), className: "h-7 text-xs border-white/10 hover:bg-white/10 hover:text-white", children: "Reset" })] })] }), _jsx(CardContent, { children: Object.keys(assetPnlHistory).length === 0 ? (_jsx("div", { className: "text-sm text-slate-500 italic py-6 text-center border border-dashed border-slate-800 rounded-lg", children: "\u017D\u00E1dn\u00FD historick\u00FD PnL zat\u00EDm ulo\u017Een." })) : (_jsx("div", { className: "space-y-3", children: Object.entries(assetPnlHistory).map(([symbol, records]) => {
                                        const latest = records[0];
                                        const sum = records.reduce((acc, r) => acc + (r.pnl ?? 0), 0);
                                        return (_jsxs("div", { className: "p-3 rounded-lg border border-white/5 bg-white/5", children: [_jsxs("div", { className: "flex items-center justify-between", children: [_jsx("span", { className: "font-mono font-semibold", children: symbol }), _jsxs("span", { className: `font-mono text-sm ${sum >= 0 ? "text-emerald-400" : "text-red-400"}`, children: ["\u03A3 ", sum >= 0 ? "+" : "", sum.toFixed(2), " USD"] })] }), latest && (_jsxs("div", { className: "text-xs text-slate-400 font-mono mt-1", children: ["Posledn\u00ED: ", latest.pnl >= 0 ? "+" : "", latest.pnl.toFixed(2), " \u00B7 ", new Date(latest.timestamp).toLocaleString()] }))] }, symbol));
                                    }) })) })] })] })] }));
}
